<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Gilbert's Data Lab</title><link href="http://WeiChengLiou.github.io/blog/" rel="alternate"></link><link href="/feeds/aws.atom.xml" rel="self"></link><id>http://WeiChengLiou.github.io/blog/</id><updated>2014-09-12T23:00:00+08:00</updated><entry><title>AWS EC2 學習筆記 -- 安裝 mongodb</title><link href="http://WeiChengLiou.github.io/blog/blog/2014/09/12/awsmongo/" rel="alternate"></link><updated>2014-09-12T23:00:00+08:00</updated><author><name>WeiCheng Liou</name></author><id>tag:WeiChengLiou.github.io,2014-09-12:blog/blog/2014/09/12/awsmongo/</id><summary type="html">&lt;p&gt;這篇講述如何在 AWS 安裝 mongodb。
基本上在 mongodb 官網有&lt;a href="http://docs.mongodb.org/ecosystem/platforms/amazon-ec2/#deploy-mongodb-ec2"&gt;相關介紹&lt;/a&gt;，
但基於個人特殊需求所以要作些客製化設定，所以紀錄於此。&lt;/p&gt;
&lt;p&gt;相關參考資料：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://emptysqua.re/blog/five-things/"&gt;Five Things About Scaling MongoDB&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://attachmentsme.tumblr.com/post/5168114317/tips-from-a-production-mongodb-deployment"&gt;Tips from a Production MongoDB Deployment&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://stuffpetedoes.blogspot.tw/2012/07/amazon-ec2-learnings.html"&gt;Amazon EC2 learnings&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;安裝 mongodb&lt;/h3&gt;
&lt;p&gt;在新創一個 instance 之前，請先開啟 security group 的 port 27017 (mongodb 預設 port)。
建立 instance 後用 ssh 登入遠端主機安裝 mongodb。 &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;sudo yum -y update

&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[MongoDB]&lt;/span&gt;
&lt;span class="s2"&gt;name=MongoDB Repository&lt;/span&gt;
&lt;span class="s2"&gt;baseurl=http://downloads-distro.mongodb.org/repo/redhat/os/x86_64&lt;/span&gt;
&lt;span class="s2"&gt;gpgcheck=0&lt;/span&gt;
&lt;span class="s2"&gt;enabled=1&amp;quot;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; sudo tee -a /etc/yum.repos.d/mongodb.repo

&lt;span class="nv"&gt;$ &lt;/span&gt;sudo yum install -y mongodb-org-server mongodb-org-shell mongodb-org-tools
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;修改 /etc/mongod.conf 設定&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;外部 IP 登入：把 bind_ip 那一行給 comment 掉。&lt;/p&gt;
&lt;p&gt;這邊要注意的是，如果資料庫打算開放給其他人使用的話，那就要在 mongodb 設定使用者權限預防資料被誤殺。
但 mongodb 僅用帳號密碼作控管，畢竟不如防火牆管制安全，故使用前請慎思。
&lt;a href="http://stackoverflow.com/questions/4767989/problem-with-access-to-mongodb-on-amazon-ec2"&gt;這篇文章&lt;/a&gt; 有另外建議用 ssh tunnel 的方式保護可供參考。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;開啟登入檢核：設定 auth = true&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;然後就可以關閉 mongod.conf 了。&lt;/p&gt;
&lt;h3&gt;新增使用者與權限&lt;/h3&gt;
&lt;p&gt;輸入 mongo 以登入 mongo shell，先新增使用者管理員帳號。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;use admin
db.createUser(
    {
        user: &amp;quot;gilbert&amp;quot;,
        pwd: &amp;quot;password1234&amp;quot;,
        roles:
        [
            {
                role: &amp;quot;userAdminAnyDatabase&amp;quot;,
                db: &amp;quot;admin&amp;quot;
            }
        ]
    }
)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以後登入 mongo shell 時，須鍵入以下指令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;mongo -u gilba -p xpkp5168 --authenticationDatabase admin
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;新增其他使用者時也用以上指令，關於內建 role 的說明可見於&lt;a href="http://docs.mongodb.org/manual/reference/built-in-roles/#built-in-roles"&gt;此處&lt;/a&gt;。
若要新增權限，可用 grantRolesToUser 指令如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;db.grantRolesToUser(
    &amp;quot;gilbert&amp;quot;,
    [
        {
            role: &amp;quot;readWriteAnyDatabase&amp;quot;,
            db: &amp;quot;admin&amp;quot;
        }
    ]
)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若想取消權限時，則使用 revokeRolesFromUser 指令。&lt;/p&gt;
&lt;h3&gt;外部登入&lt;/h3&gt;
&lt;p&gt;先記下遠端 instance IP (假設為 192.168.1.1)，然後在本地端嘗試登入 mongo shell：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;mongo 192.168.1.1 -u gilbert -p password1234 --authenticationDatabase admin
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若出現以下錯誤訊息可不用理會：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;Error while trying to show server startup warnings: not authorized on admin to execute command { getLog: &amp;quot;startupWarnings&amp;quot; }
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接著可以試著玩玩看了。&lt;/p&gt;</summary><category term="AWS"></category><category term="mongodb"></category></entry><entry><title>AWS EC2 學習筆記 -- Use AWS EC2 Command Line Tools</title><link href="http://WeiChengLiou.github.io/blog/blog/2014/09/12/awssetup/" rel="alternate"></link><updated>2014-09-12T11:55:00+08:00</updated><author><name>WeiCheng Liou</name></author><id>tag:WeiChengLiou.github.io,2014-09-12:blog/blog/2014/09/12/awssetup/</id><summary type="html">&lt;p&gt;本文談論如何利用 AWS EC2 Command Line Tools (簡稱 CLI) 建立 instances。
雖說 AWS 可透過瀏覽器的 Console 介面建立 instance，但畢竟使用上沒那麼靈活。
若能在 terminal 利用 CLI 建立及取消 instances，那麼在進行平行計算上會十分方便。&lt;/p&gt;
&lt;p&gt;以下是看了幾天 AWS 文件後，自行摸索出來的操作步驟，以後也可以寫成 script 方便使用。
參考資料在此：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/ec2-clt.pdf"&gt;安裝及指令手冊&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://aws.amazon.com/marketplace/ref=lbr_navhdr_header"&gt;AWS marketplace&lt;/a&gt;：查詢現有的 Amazon Machine Image 代號與價格 (AMI)&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;AWS EC2 概要說明&lt;/h3&gt;
&lt;p&gt;基本上建立 instance 大概是這樣的：你不能光建個 instance 就以為萬事太平。
你還要設定 security group 讓你可以用 ssh 連進去，再來還要有個 public IP 讓 ssh 有地方連，要有 Key-pair 作為 ssh 登入鑰匙。
事情大概就是這樣，接下來我們就要細談操作步驟。&lt;/p&gt;
&lt;h3&gt;設定步驟說明&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;安裝 AWS CLI Tools&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;創造 Key-pair&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-create-keypair my-key-pair
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;創造/設定 security group
    首先藉由預設 security group 查詢預設的 vpc，或者你也可以自行創建。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-describe-group

GROUP   sg-d04b6db5     266317072757    default default VPC security group      vpc-xxxxxxxx
PERMISSION      266317072757    default ALLOWS  all                     FROM    USER    266317072757            ID sg-d04b6db5  ingress
PERMISSION      266317072757    default ALLOWS  all                     TO      CIDR    0.0.0.0/0       egress
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;上面的 &lt;strong&gt;vpc-xxxxxxx&lt;/strong&gt; 就是 vpc ID，接著創造 security group：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-create-group mygrp -d &amp;quot;My group&amp;quot; -c vpc-xxxxxxxx
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接著設定 security group，這邊先設定允許 ssh 登入的 port 與 IP。
IP 要輸入電腦的真實 IP，這邊假設真實 IP 為 192.168.1.1，若不知道者可從這裡&lt;a href="http://checkrealip.com/"&gt;查詢&lt;/a&gt;：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-authorize mygrp -P tcp -p 22 -s 192.168.1.1/24
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;或是可以直接設定為 0.0.0.0/0，這樣全世界的電腦都可以透過 ssh 連進去了。&lt;/p&gt;
&lt;p&gt;接著檢查已設定的 security group：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-describe-group mygrp
GROUP   sg-af1234ca     266317072757    mygrp   My group        vpc-bb11a1de
PERMISSION      266317072757    mygrp   ALLOWS  tcp     22      22      FROM    CIDR    1.161.0.0/16    ingress
PERMISSION      266317072757    mygrp   ALLOWS  all                     TO      CIDR    0.0.0.0/0       egress
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;其中 &lt;strong&gt;sg-af1234ca&lt;/strong&gt; 就是我們新創之security group 的 ID，這個要記起來等下設定 instance 時會用到。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;設定 instance&lt;/p&gt;
&lt;p&gt;先至 &lt;a href="https://aws.amazon.com/marketplace/ref=lbr_navhdr_header"&gt;AWS marketplace&lt;/a&gt; 找合適的 image。image 就是映像檔，根據不同需求、地區、cpu 等級而有不同定價，比如說我的預設 region 是 us-east，最便宜的 image 為 &lt;a href="https://aws.amazon.com/marketplace/pp/B00CIYTQTC/ref=gtw_msl_title?ie=UTF8&amp;amp;pf_rd_r=0KRNNBW3CGDSBVWNDA9D&amp;amp;pf_rd_m=A33KC2ESLMUT5Y&amp;amp;pf_rd_t=101&amp;amp;pf_rd_i=awsmp-gateway-1&amp;amp;pf_rd_p=1841533842&amp;amp;pf_rd_s=right-3"&gt;Amazon Linux AMI(HVM/64 bit)&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;instance type 中 t2.micro 的價格最便宜，第一次玩就用這個了。基本上一分錢一分貨，想要效能好一點就要挑貴的，如果只是嘗鮮就先拿簡單的來練練，等有感覺了再升級。&lt;/p&gt;
&lt;p&gt;選好 image 後按下 Continue 鈕，選 Manual Launch 的分頁，就可以看到不同地區的 ID。這邊選 US East 的 ID 為 ami-978d91fe。&lt;/p&gt;
&lt;p&gt;選好 iamge 與主機類型後，就可以設定 instance 了&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-run-instances ami-978d91fe -t t2.micro -k thinkpad -g sg-af1234ca --associate-public-ip-address true

RESERVATION     r-fbe183d0      266317072757
INSTANCE        i-5d0da4b6      ami-978d91fe            ip-172-31-31-196.ec2.internal   pending thinkpad        0               t2.micro        2014-09-11T12:37:29+0000        us-east-1b              monitoring-disabled              172.31.31.196   vpc-bb11a1de    subnet-6022f317 ebs                                     hvm     xen             sg-af1234ca     default false
NIC     eni-7a10a00c    subnet-6022f317 vpc-bb11a1de    266317072757    in-use  172.31.31.196   ip-172-31-31-196.ec2.internal   true
NICATTACHMENT   eni-attach-46a8cb25     0       attaching       2014-09-11T20:37:29+0800        true
GROUP   sg-af1234ca     mygrp
PRIVATEIPADDRESS        172.31.31.196   ip-172-31-31-196.ec2.internal
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;出現以上訊息就算是設定成功了。&lt;strong&gt;i-5d0da4b6&lt;/strong&gt; 為這次新創之 instance ID，之後停止或中斷時都會用到，忘記的話可以用 ec2-describe-instances 指令查詢。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;測試 ssh 連線&lt;/p&gt;
&lt;p&gt;首先要先知道剛新創之 instance 的 Public IP。這邊建議用 AWS Command Line Tool 的指令來查會比較清楚：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; aws ec2 describe-instances
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接著在回傳的一大串 json 字串裡找到 PublicIp 就是了。每次新創的 instance 之 Public IP 不一定會相同，這邊找到的是 54.165.147.88。&lt;/p&gt;
&lt;p&gt;接著就可以用 ssh 作測試：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;ssh&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="n"&gt;ThinkPad&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pem&lt;/span&gt; &lt;span class="n"&gt;ec2&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;user&lt;/span&gt;&lt;span class="mf"&gt;@54.165.147.88&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;接著會出現訊息詢問是否要新增目標 IP 的指紋 (fingerprint)，選 yes 後出現類似以下訊息應該就算登入成功了。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;The authenticity of host &amp;#39;54.165.147.88 (54.165.147.88)&amp;#39; can&amp;#39;t be established.
ECDSA key fingerprint is ce:b1:41:dc:f7:88:85:5b:68:c2:7c:21:7a:04:d1:a4.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &amp;#39;54.165.147.88&amp;#39; (ECDSA) to the list of known hosts.

    __|  __|_  )
    _|  (     /   Amazon Linux AMI
    ___|\___|___|

https://aws.amazon.com/amazon-linux-ami/2014.03-release-notes/
16 package(s) needed for security, out of 44 available
Run &amp;quot;sudo yum update&amp;quot; to apply all updates.
[ec2-user@ip-172-31-31-196 ~]$
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;停止/中斷 instance&lt;/p&gt;
&lt;p&gt;使用完畢後要記得把 instance 停止，免得他繼續計費。以下是停止跟中斷的命令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&amp;gt;&amp;gt; ec2-stop-instances i-5d0da4b6

&amp;gt;&amp;gt; ec2-terminate-instances i-5d0da4b6
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上就是一個 AWS instance 誕生跟毀滅的過程。希望大家有基本概念後，多玩幾次、多看參考文件，可以幫助你更快進入狀況。&lt;/p&gt;</summary><category term="AWS"></category><category term="EC2"></category></entry></feed>